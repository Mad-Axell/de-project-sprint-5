# Проектная работа по DWH для нескольких источников

## Задача проекта
Конечная задача — реализовать витрину для расчётов с курьерами. В ней вам необходимо рассчитать суммы оплаты каждому курьеру за предыдущий месяц. Например, в июне выплачиваем сумму за май. Расчётным числом является 10-е число каждого месяца (это не повлияет на вашу работу). Из витрины бизнес будет брать нужные данные в готовом виде.
Для этого нужно создать многослойный DWH и реализовать ETL-процессы, которые будут преобразовывать и перемещать данные от источников до конечных слоёв данных.

###Необходимо:
Изучить возможные источники и их внутреннюю модель хранения данных, а также технологии, которые используются для получения данных из этих источников.
На основе требований, целей дальнейшего использования, информации об источниках нужно спроектировать многослойную модель DWH, подробно прорабатывая каждый слой данных.
Для передачи результатов заказчику оформить всю необходимую документацию.


###Состав витрины:

- **id** — идентификатор записи.
- **courier_id** — ID курьера, которому перечисляем.
- **courier_name** — Ф. И. О. курьера.
- **settlement_year** — год отчёта.
- **settlement_month** — месяц отчёта, где 1 — январь и 12 — декабрь.
- **orders_count** — количество заказов за период (месяц).
- **orders_total_sum** — общая стоимость заказов.
- **rate_avg** — средний рейтинг курьера по оценкам пользователей.
- **order_processing_fee** — сумма, удержанная компанией за обработку заказов, которая высчитывается как orders_total_sum * 0.25.
- **courier_order_sum** — сумма, которую необходимо перечислить курьеру за доставленные им/ей заказы. За каждый доставленный заказ курьер должен получить некоторую сумму в зависимости от рейтинга (см. ниже).
- **courier_tips_sum** — сумма, которую пользователи оставили курьеру в качестве чаевых.
- **courier_reward_sum** — сумма, которую необходимо перечислить курьеру. Вычисляется как courier_order_sum + courier_tips_sum * 0.95 (5% — комиссия за обработку платежа).

Правила расчёта процента выплаты курьеру в зависимости от рейтинга, где r — это средний рейтинг курьера в расчётном
месяце:

- r < 4 — 5% от заказа, но не менее 100 р.;
- 4 <= r < 4.5 — 7% от заказа, но не менее 150 р.;
- 4.5 <= r < 4.9 — 8% от заказа, но не менее 175 р.;
- 4.9 <= r — 10% от заказа, но не менее 200 р.

Отчёт собирается по дате заказа.

Данные о заказах уже есть в хранилище. Данные курьерской службы вам необходимо забрать из API курьерской службы, после чего совместить их с данными подсистемы заказов.
Отчёт собирается по дате заказа. Если заказ был сделан ночью и даты заказа и доставки не совпадают, в отчёте стоит ориентироваться на дату заказа, а не дату доставки. Иногда заказы, сделанные ночью до 23:59, доставляют на следующий день: дата заказа и доставки не совпадёт. Это важно, потому что такие случаи могут выпадать в том числе и на последний день месяца. Тогда начисление курьеру относите к дате заказа, а не доставки.












































### Как работать с репозиторием
1. В вашем GitHub-аккаунте автоматически создастся репозиторий `de-project-sprint-5` после того, как вы привяжете свой GitHub-аккаунт на Платформе.
2. Скопируйте репозиторий на свой локальный компьютер, в качестве пароля укажите ваш `Access Token` (получить нужно на странице [Personal Access Tokens](https://github.com/settings/tokens)):
	* `git clone https://github.com/{{ username }}/de-project-sprint-5.git`
3. Перейдите в директорию с проектом: 
	* `cd de-project-sprint-5`
4. Выполните проект и сохраните получившийся код в локальном репозитории:
	* `git add .`
	* `git commit -m 'my best commit'`
5. Обновите репозиторий в вашем GutHub-аккаунте:
	* `git push origin main`

### Структура репозитория
- `/src/dags`

### Как запустить контейнер
Запустите локально команду:

```
docker run \
-d \
-p 3000:3000 \
-p 3002:3002 \
-p 15432:5432 \
--mount src=airflow_sp5,target=/opt/airflow \
--mount src=lesson_sp5,target=/lessons \
--mount src=db_sp5,target=/var/lib/postgresql/data \
--name=de-sprint-5-server-local \
sindb/de-pg-cr-af:latest
```

После того как запустится контейнер, вам будут доступны:
- Airflow
	- `localhost:3000/airflow`
- БД
	- `jovyan:jovyan@localhost:15432/de`
